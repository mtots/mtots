import sys
import gg
from media import Image
from media import Audio
from random import Random

print("isArchiveScript = %s" % [sys.isArchiveScript()])
print("__file__ = %s" % [__file__])

final rand = Random()
final WIDTH = 800
final HEIGHT = 800

final window = gg.Window("Hello", WIDTH, HEIGHT, 60)

var tick = 0

final ballImage = Image(100, 100)
for i in range(ballImage.width):
  for j in range(ballImage.height):
    if ((i - ballImage.width // 2) ** 2) + ((j - ballImage.height // 2) ** 2) < 30 ** 2:
      ballImage.set(i, j, Color(255, 255, 255))
final ballGeometry = window.newPolygon(
  [V(-1, -1), V(1, -1), V(1, 1), V(-1, 1)],
  nil,
  window.newTexture(ballImage))


class Ball:
  var color Color
  var x Int
  var y Int
  var width Int
  var height Int
  var angle Float
  def __init__(color Color, x Int, y Int, width Int, height Int, angle Float):
    this.color = color
    this.x = x
    this.y = y
    this.width = width
    this.height = height
    this.angle = angle

  def blit():
    ballGeometry.setColor(this.color)
    ballGeometry.transform.reset()
    ballGeometry.transform.scaleX(this.width / 2)
    ballGeometry.transform.scaleY(this.height / 2)
    ballGeometry.transform.rotateZ(this.angle)
    ballGeometry.transform.translate(V(this.x, this.y))
    ballGeometry.blit()


final balls List[Ball] = []
for i in range(100):
  final color = Color(rand.int(0, 255), rand.int(0, 255), rand.int(0, 255))
  final x = rand.number() * WIDTH
  final y = rand.number() * HEIGHT
  final width = 50 + 100 * rand.number()
  final height = 50 + 100 * rand.number()
  balls.append(Ball(color, x, y, width, height, 0))

var angleY = 0
var angleZ = 0

final audio = Audio.fromSampleCount(44100)
for i in range(44100):
  audio.set(i, 0, sin(i / 44100 * 440 * TAU) * ((2 ** 15) - 1))

gg.loadAudio(audio, 0)
gg.setAudioVolume(0, 128)

var started = false

@window.onUpdate
def():
  tick = tick + 1

  if tick % 1 == 0:
    # window.clear(Color(0, 0, 0, 255))

    for ball in balls:
      ball.angle = TAU * (tick / 60)

  if gg.mouseButton(0, 0):
    gg.setSynth(0, 0, 440, 1)

  if gg.mouseButton(0, 1):
    gg.setSynth(0, 0, 0, 0)

  if gg.key(gg.KEY.F, 0, false):
    if started:
      gg.pauseAudio(0, false)
    else:
      gg.playAudio(0, -1)
    # gg.setSynth(0, 0, 300, 1)

  if gg.key(gg.KEY.F, 1):
    # gg.setSynth(0, 0, 0, 0)
    # gg.setAudioVolume(0, 0)
    gg.pauseAudio(0, true)

  sys.enableMallocFreeLogs(true)
  for ball in balls:
    ball.blit()

  ballGeometry.setVertexColor(0, gg.RED)
  ballGeometry.setVertexColor(1, gg.GREEN)
  ballGeometry.setVertexColor(2, gg.BLUE)
  ballGeometry.setVertexColor(3, gg.LIGHT_YELLOW)
  ballGeometry.transform.reset()
  ballGeometry.transform.scaleX(80)
  ballGeometry.transform.scaleY(80)
  ballGeometry.transform.rotateY(angleY)
  ballGeometry.transform.rotateZ(angleZ)
  ballGeometry.transform.translate(V(WIDTH / 2, HEIGHT / 2))
  ballGeometry.blit()

  angleZ = angleZ + 0.014
  angleY = angleY + 0.06

  sys.enableMallocFreeLogs(false)
